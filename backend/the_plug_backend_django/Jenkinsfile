pipeline {
    agent docker-agent

    environment {
        SONAR_TOKEN_BACKEND = credentials('sonar-token-backend')
        DB_PASSWORD = credentials('db-password')
        DB_USER = 'admin'
        DB_NAME = 'postgres'
        DB_HOST = 'localhost:5432'
        EMAIL_HOST_PASSWORD = credentials('email-host-password')
        EMAIL_HOST_USER = credentials('email-host-user')
        SECRET_KEY = credentials('secret-key')
        ALLOWED_HOSTS = '*'
        DEBUG = '1'
        CACHE_ENDPOINT = 'no'
        CACHE_PASSWORD = 'no'
        USE_CACHE = '0'
        DOCKER_REGISTRY = 'https://docker.io'
        BACKEND_IMAGE = 'wallys02/the-plug-backend'
        PIP_CACHE_DIR = "${env.HOME}/.cache/pip"
        NPM_CONFIG_CACHE = "${env.HOME}/.cache/npm"
        KUBECONFIG = "${env.HOME}/.kube/config"
        BACKEND_DIR = 'backend/the_plug_backend_django'
        FRONTEND_DIR = 'frontend/the_plug_svelte_frontend'
    }

    triggers {
        pollSCM '* * * * *'
    }

    stages {
            stage('SonarQube Analysis') {
                steps {
                    dir($BACKEND_DIR) {
                        withSonarQubeEnv('SonarQube-Server') {
                            sh 'sonar-scanner -Dsonar.projectBaseDir=. -Dsonar.token=$SONAR_TOKEN_BACKEND'
                        }
                    }
                }
            }

            stage('Backend Tests') {
                steps {
                    dir($BACKEND_DIR) {
                        sh '''
                            python3 -m pip install --upgrade pip
                            pip install -r requirements.txt
                            python3 manage.py makemigrations api
                            python3 manage.py test
                        '''
                    }
                }
            }

            stage('Run Services') {
                steps {
                    parallel(
                        'Backend': {
                            dir($BACKEND_DIR) {
                                sh '''
                                    python3 manage.py migrate --settings=the_plug_backend_django.e2e_test_settings
                                    python3 manage.py loaddata api/fixtures/herbs.json --settings=the_plug_backend_django.e2e_test_settings
                                    nohup python3 manage.py runserver 0.0.0.0:8080 --settings=the_plug_backend_django.e2e_test_settings &
                                '''
                            }
                        },
                        'Frontend': {
                            dir($FRONTEND_DIR) {
                                sh '''
                                    npm ci
                                    nohup npm run dev -- --port 4200 &
                                '''
                            }
                        }
                    )
                }
            }

            stage('E2E Tests') {
                steps {
                    dir($FRONTEND_DIR) {
                        sh '''
                            npx wait-on http://localhost:8080/api/herb/list/
                            npx wait-on http://localhost:4200
                            npx cypress run --config-file cypress.config.ts --browser chrome --config baseUrl=http://localhost:4200
                        '''
                    }
                }
            }

            stage('Performance Tests') {
                steps {
                    dir($BACKEND_DIR) {
                        sh 'locust -f locustfile.py --headless -u 100 -r 10 -t 3m --host http://localhost:8080/api'
                    }
                }
            }

            stage('DAST Tests') {
                steps {
                    script {
                        docker.image('ghcr.io/zaproxy/zaproxy:stable').inside {
                            sh '''
                                mkdir -p /zap/wrk
                                zap-full-scan.py -t http://localhost:8080/api/
                            '''
                        }
                    }
                }
            }

            stage('Cleanup') {
                steps {
                    sh '''
                        pkill -f "python3 manage.py runserver" || true
                        pkill -f "npm run dev" || true
                        rm -f backend/the_plug_backend_django/db.sqlite3
                    '''
                }
            }

            stage('Docker Build & Push') {
                steps {
                    script {
                        docker.withRegistry($DOCKER_REGISTRY, 'dockerhub-creds') {
                            docker.build('wallys02/the-plug-backend:latest', './backend/the_plug_backend_django')
                                .push()
                        }
                    }
                }
            }

            stage('Helm Deployment') {
                steps {
                    dir('k8s/helm/the-plug') {
                        sh '''
                            chmod +x ./run-helm.sh
                            ./run-helm.sh
                            kubectl rollout restart deployment/backend --namespace plug-namespace
                        '''
                    }
                }
            }
    }

    post {
        always {
            cleanWs()
        }
    }
}
